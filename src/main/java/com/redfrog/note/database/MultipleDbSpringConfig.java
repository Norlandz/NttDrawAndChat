package com.redfrog.note.database;

import java.util.Properties;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.context.annotation.Profile;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;

//__________________________________________________________________________________________________
//_________________________________________________________________
//__________________________________________________________________________________________________________
//__________________________________________________________________________________________________
@Configuration
//____________________________
@Profile({ "Enable_LoadSaveFile", "prod" })
public class MultipleDbSpringConfig {

  @Value("${spring.ds-mysql-01.hibernate.dialect}")
  private String dialect_01;

  @Value("${spring.ds-mysql-02.hibernate.dialect}")
  private String dialect_02;

  //____________
  //__________________________________________________________

  //____________
  //____________________________________________

  @Primary
  @Bean
  @ConfigurationProperties(prefix = "spring.ds-mysql-01") //__________________________________________________________________________
  public DataSource ds_mysql_01() {
    return DataSourceBuilder.create().build();

    //_________________________________________________________________________________________________________________________________________________________________________________
    //__________________________________________________________
    //________________________________________________
    //_____
    //__________
    //_____________________________________________________________________________________________________________________
    //__________________________________________
    //___________________________________________________________________
    //___________________________________________________________________________
    //_________________________________________________________________________________________________________________
    //______________________________________________________________________________________________________________
    //______________________________________________________________________________________________________________
    //______________________________________________________________________________________________________________________________________
    //___________________________________________________
    //
    //_____
  }

  @Bean
  @ConfigurationProperties(prefix = "spring.ds-mysql-02")
  public DataSource ds_mysql_02() { return DataSourceBuilder.create().build(); }

  public static final int BatchSize = 50; //_________________

  @Primary
  @Bean
  public LocalContainerEntityManagerFactoryBean lcemf_01(
                                                         EntityManagerFactoryBuilder builder,
                                                         @Qualifier("ds_mysql_01") DataSource ds) {

    Properties properties = new Properties();
    properties.setProperty("hibernate.dialect", dialect_01);

    //___
    //________________________________________________________________
    //___
    //___________________________________________________________________________________________________
    //_
    //___
    //_________________________
    //__________________________________________________
    //___________________________________
    //_______________________________________________________________________
    //_________________________
    //__________________________
    //___
    //_______________________________________________________________________________________________________________
    //___________________________________________________________
    properties.setProperty("hibernate.hbm2ddl.auto", "update");

    //________________________________________________________________________________________________________
    properties.setProperty("hibernate.physical_naming_strategy", "org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy");

    //_________________________________________________________________________

    //_________
    //_________________________________________________________
    //___________________________________________________________
    //_________________________________________________________________
    //_________
    //__________________________________________________________________________
    //_________________________________________________________
    //___________________________________________________________
    //_________________________________________________________________
    //
    //____________________________________________
    //_____________________________________________
    //___________________________________________________________________________________________________________________________

    //______________________________________________________
    //_______________________________________________

    //__________________________________________________________________

    //___
    //________________________________________________________________________________________________________________________________________________________________
    //_
    //______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
    //___
    //__________________________________________________________________________________

    //____________________________________________________________________________________________________________________________________________

    //_____________________________________________________________________________________________________________________
    //_______________________________________________________

    //_______________________________________________________________________

    //_________________________________________________________________________________________________________________________________

    //_____________________________________________________________________________

    //_
    //___
    //____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
    //____________________________________________________

    properties.put("hibernate.jdbc.batch_size", BatchSize);
    properties.put("hibernate.order_inserts", "true");

    //_________________________________________________________________________________
    properties.put("hibernate.order_updates", "true");
    properties.put("hibernate.batch_versioned_data", "true");

    properties.put("hibernate.generate_statistics", "true");

    LocalContainerEntityManagerFactoryBean emf = builder
                                                        .dataSource(ds)
                                                        .packages("com.redfrog.note")
                                                        .persistenceUnit("pu_mysql_01")
                                                        .build();

    emf.setJpaProperties(properties);

    emf.setJpaVendorAdapter(new HibernateJpaVendorAdapter());

    return emf;

  }

  @Bean
  public LocalContainerEntityManagerFactoryBean lcemf_02(
                                                         EntityManagerFactoryBuilder builder,
                                                         @Qualifier("ds_mysql_02") DataSource ds) {

    Properties properties = new Properties();
    properties.setProperty("hibernate.dialect", dialect_02);
    properties.setProperty("hibernate.hbm2ddl.auto", "update");
    properties.setProperty("hibernate.physical_naming_strategy", "org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy");

    //_________________________________________________________
    //___________________________________________________________
    //_________________________________________________________________

    LocalContainerEntityManagerFactoryBean emf = builder
                                                        .dataSource(ds)
                                                        .packages("com.redfrog.note")
                                                        .persistenceUnit("pu_mysql_02")
                                                        .build();

    emf.setJpaProperties(properties);

    emf.setJpaVendorAdapter(new HibernateJpaVendorAdapter());

    return emf;
  }

  //_________________________________________________________
  //_______
  //____________
  //___________________________________________________________________________________________________
  //________________________________________
  //___

  @Primary
  @Bean
  public PlatformTransactionManager txm_01(@Qualifier("lcemf_01") LocalContainerEntityManagerFactoryBean lcemf_01) {
    JpaTransactionManager tm = new JpaTransactionManager();
    tm.setEntityManagerFactory(lcemf_01.getObject());
    //____________________________________
    return tm;
  }

  @Bean
  public PlatformTransactionManager txm_02(@Qualifier("lcemf_02") LocalContainerEntityManagerFactoryBean lcemf_02) {
    JpaTransactionManager tm = new JpaTransactionManager();
    tm.setEntityManagerFactory(lcemf_02.getObject());
    //______________________________________________________________________________________________________________
    return tm;
  }

}